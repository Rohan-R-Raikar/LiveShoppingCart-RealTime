@using Microsoft.AspNetCore.Identity
@* @inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager *@

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - LiveShoppingCart_RealTime</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZj1D0x8d0N5C4z5vYw6jLRv8Z4C1U5IYbYl+1d9P4Z4z2Q5a+QhE2ag=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Local CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/LiveShoppingCart_RealTime.styles.css" asp-append-version="true" />
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm mb-4">
            <div class="container">
                <a class="navbar-brand fw-bold" asp-area="" asp-controller="Home" asp-action="Index">
                    LiveShoppingCart_RealTime
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarContent" aria-controls="navbarContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Home" asp-action="Index">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Products" asp-action="Index">Products</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark d-flex align-items-center" asp-controller="Cart" asp-action="Index">
                                <i class="fa-solid fa-cart-shopping me-1"></i>Cart
                                <span class="badge bg-danger ms-1" id="cartCount">0</span>
                            </a>
                        </li>
                    </ul>

                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <li class="nav-item d-flex align-items-center me-2">
                                <span class="nav-link text-dark">Hello, <strong>@User.Identity?.Name</strong>!</span>
                            </li>
                            <li class="nav-item">
                                <form asp-area="Identity" asp-page="/Account/Logout" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-dark btn-sm">Logout</button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-primary btn-sm" asp-area="Identity" asp-page="/Account/Login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="btn btn-primary btn-sm" asp-area="Identity" asp-page="/Account/Register">Register</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main role="main" class="container flex-grow-1 py-4">
        @RenderBody()
    </main>

    <!-- Footer -->
    <footer class="mt-auto bg-light py-3 border-top">
        <div class="container text-center text-muted">
            &copy; 2025 LiveShoppingCart_RealTime &middot;
            <a class="text-decoration-none" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-3fab8d8f4a63f8e0f3f1fa4623087c51ff3b80bfa1b"
            crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"
            integrity="sha512-km8F+xZ1F4FjMZ4CXBaXnBGxM7Z4o5+59/YFm6nGQZy1XnSmuh4HR3sSODzHNaPZJ0eTzCVxKMx91lmHxZ2Xbw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

    <!-- Local JS -->
    <script src="~/js/site.js" asp-append-version="true"></script>

    <!-- SweetAlert Toast Message from TempData -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const message = '@TempData["SweetAlertMessage"]';
            const type = '@TempData["SweetAlertType"]';

            if (message) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: type || 'info',
                    title: message,
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }
        });
    </script>

    <!-- SignalR Live Cart Updates -->
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        connection.start()
            .then(() => console.log("Connected to SignalR Hub"))
            .catch(err => console.error("SignalR Connection Error:", err.toString()));

        // Listen for cart update messages and update UI dynamically
        connection.on("CartUpdated", (data) => {
            console.log("CartUpdated event received:", data);

            // Show SweetAlert Toast
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: data.message || "Cart updated!",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            // Update product stock dynamically if the product exists on page
            if (data.productId && data.newStock !== undefined) {
                const stockElements = document.querySelectorAll(`[data-product-id='${data.productId}'] .product-stock`);
                stockElements.forEach(el => {
                    el.textContent = data.newStock;
                });
            }
        });

                connection.on("NewProductAdded", data => {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: data.message || "Product List Updated!",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            if (data.product !== undefined) {
                const container = document.querySelector('.row.row-cols-1.row-cols-md-3.g-4');

                const newProductHtml = `
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold">${data.product.name}</h5>
                            <p class="card-text text-muted">${data.product.description}</p>
                            <p class="card-text mb-2"><strong>Price:</strong> ${data.product.price.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                            <p class="card-text mb-3" data-product-id="${data.product.id}">
                                <strong>Stock:</strong> <span class="product-stock">${data.product.stock}</span>
                            </p>
                            <div class="mt-auto d-grid gap-2">
                                <a href="/Products/Details/${data.product.id}" class="btn btn-info btn-sm w-100">
                                    <i class="bi bi-info-circle"></i> Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;

                container.insertAdjacentHTML('beforeend', newProductHtml);
            }
        });

    </script>


    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>
